version: '3.8'

services:
  db:
    image: postgres:15-alpine
    container_name: chatapp_db_prod
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-chatdb}
      POSTGRES_USER: ${POSTGRES_USER:-chatuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-chatpass123}
    restart: always

  redis:
    image: redis:7-alpine
    container_name: chatapp_redis_prod
    restart: always

  backend:
    build:
      context: ./backend
    container_name: chatapp_backend_prod
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             daphne -b 0.0.0.0 -p 8000 chatapp.asgi:application"
    volumes:
      - static_volume:/app/staticfiles
    depends_on:
      - db
      - redis
    environment:
      DEBUG: "False"
      SECRET_KEY: ${SECRET_KEY:-change_this_in_production_please}
      ALLOWED_HOSTS: tilakapi.enlightbook.com
      CORS_ALLOWED_ORIGINS: http://tilak.enlightbook.com,https://tilak.enlightbook.com
      CSRF_TRUSTED_ORIGINS: http://tilak.enlightbook.com,https://tilak.enlightbook.com
      DATABASE_URL: postgres://${POSTGRES_USER:-chatuser}:${POSTGRES_PASSWORD:-chatpass123}@db:5432/${POSTGRES_DB:-chatdb}
      REDIS_HOST: redis
    ports:
      - "8001:8000"  # expose backend to host
    restart: always

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://tilakapi.enlightbook.com}
        REACT_APP_WS_URL: ${REACT_APP_WS_URL:-ws://tilakapi.enlightbook.com}
    container_name: chatapp_frontend_prod
    ports:
      - "8080:80"  # expose frontend to host port 8080
    restart: always

# Remove Docker Nginx container; host Nginx handles routing
# nginx:
#   image: nginx:stable-alpine
#   container_name: chatapp_nginx_prod
#   ports:
#     - "80:80"
#   volumes:
#     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
#     - static_volume:/app/staticfiles:ro
#   depends_on:
#     - backend
#     - frontend
#   restart: always

volumes:
  postgres_data:
  static_volume:
